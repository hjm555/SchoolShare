<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hjm.dao.GoodDao">
    <resultMap id="simple" type="com.hjm.model.Good">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="type" property="type"/>
        <result column="description" property="description"/>
        <association column="ownerId" property="owner" select="com.hjm.dao.UserDao.getById"/>
        <collection  column="id" property="urls" select="selectImage"/>
    </resultMap>

    <select id="getById" resultMap="simple">
        select * from hjm_good
        where id=#{id}
    </select>

    <select id="getOne" resultMap="simple">
        select * from hjm_good
        where 1=1
        <if test="id!=null and id!=''">
            and id=#{id}
        </if>
        <if test="name!=null and name!=''">
            and name=#{name}
        </if>
        <if test="type!=null and type!=''">
            and type=#{type}
        </if>
        <if test="state!=null and state!=''">
            and state=#{state}
        </if>
        <if test="owner!=null">
            <if test="owner.id!=null and owner.id!=''">
                and ownerId = #{owner.id}
            </if>
        </if>
        <if test="borrower!=null">
            <if test="borrower.id!=null and borrower.id!=''">
                and borrowerId=#{borrower.id}
            </if>
        </if>
    </select>

    <select id="getList" resultMap="simple">
        select * from hjm_good
        where 1=1
        <if test="id!=null and id!=''">
            and id=#{id}
        </if>
        <if test="name!=null and name!=''">
            and name=#{name}
        </if>
        <if test="type!=null and type!=''">
            and type=#{type}
        </if>
        <if test="state!=null and state!=''">
            and state=#{state}
        </if>
        <if test="owner!=null">
            <if test="owner.id!=null and owner.id!=''">
                and ownerId = #{owner.id}
            </if>
        </if>
        <if test="borrower!=null">
            <if test="borrower.id!=null and borrower.id!=''">
                and borrowerId=#{borrower.id}
            </if>
        </if>
    </select>

    <select id="homePage" resultMap="simple">
        select * from hjm_good
        order by release_time DESC
    </select>

    <select id="searchByName" resultMap="simple">
        select * from hjm_good where (name like #{goodName} or description like #{goodName})and state='未共享'
        order by release_time DESC
    </select>

    <select id="selectImage" resultType="java.lang.String">
        select url from hjm_picture
        where goodId = #{id}
    </select>

    <insert id="insert">
        insert into hjm_good(id,name,type,description,ownerId,borrowerId,state,release_time)
        value(#{id},#{name},#{type},#{description},#{owner.id},#{borrower.id},#{state},#{releaseTime})
    </insert>

    <update id="update">
        update hjm_good
        <set>
            <if test="name!=null and name!=''">
                name=#{name},
            </if>
            <if test="type!=null and type!=''">
                type=#{type},
            </if>
            <if test="description!=null">
                description=#{description},
            </if>
            <if test="state!=null state!=''">
                state=#{state},
            </if>
            <if test="borrower!=null">
                <if test="borrower.id!=null and borrower.id!=''">
                    borrowerId=#{borrower.id},
                </if>
            </if>
            <if test="releaseTime!=null and releaseTime!=''">
                release_time=#{releaseTime},
            </if>
        </set>
        where id = #{id}
        <if test="owner!=null">
            <if test="owner.id!=null and owner.id!=''">
                and ownerId = #{owner.id}
            </if>
        </if>
    </update>

    <update id="updateState">
        update hjm_good set state='已共享'
        where id=#{id}
    </update>

    <update id="deleteBorrow">
        update hjm_good
        <set>
            <if test="borrower!null">
                <if test="borrower.id!=null and borrower.id!=''">
                    borrowId='null',
                </if>
            </if>
        </set>
        where borrowId=#{borrower.id} and id=#{id}
    </update>

    <update id="deleteAllBorrow">
        update hjm_good
        <set>
            <if test="borrower!null">
                <if test="borrower.id!=null and borrower.id!=''">
                    borrowId='null',
                </if>
            </if>
        </set>
        where borrowId=#{borrower.id}
    </update>

    <delete id="delete">
        delete from hjm_good where id=#{id}
    </delete>

    <delete id="deleteList">
        delete from hjm_good where id in
        <foreach collection="list" open="(" separator="," close=")" item="item">
            #{item.id}
        </foreach>
    </delete>

    <delete id="deleteAll">
        delete from hjm_good_share where 1=1
        <set>
            <if test="owner!=null">
                <if test="owner.id!=null and owner.id!=''">
                    and ownerId in
                    <foreach collection="list" open="(" separator="," close=")" item="item">
                        #{item.id}
                    </foreach>
                </if>
            </if>
            <if test="borrower!=null">
                <if test="borrower.id!=null and borrow.id!=''">
                    and borrowId in
                    <foreach collection="list" open="(" separator="," close=")" item="item">
                        #{item.id}
                    </foreach>
                </if>
            </if>
        </set>
    </delete>


</mapper>